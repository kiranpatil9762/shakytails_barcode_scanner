<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - ShakyTails</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-right: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .stat-card p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stat-card.green {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .stat-card.orange {
            background: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
        }

        .stat-card.blue {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        }

        .hidden {
            display: none !important;
        }

        .user-info {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th {
            background: #667eea;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .badge.success {
            background: #d4edda;
            color: #155724;
        }

        .badge.warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge.info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            padding: 12px 25px;
            background: #e0e0e0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .activity-item {
            padding: 15px;
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            margin-bottom: 10px;
            border-radius: 5px;
        }

        .activity-item .time {
            color: #666;
            font-size: 0.85rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ“Š Admin Dashboard</h1>
            <p>ShakyTails System Overview</p>
        </div>

        <!-- Login Card -->
        <div class="card" id="loginCard">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="adminEmail" value="theshakytails@gmail.com" required>
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="adminPassword" value="Shakytails@123" required>
                </div>
                <button type="submit" class="btn">Login as Admin</button>
            </form>
            <div id="loginResult" class="result"></div>
        </div>

        <!-- Dashboard -->
        <div id="dashboardContent" class="hidden">
            <!-- User Info -->
            <div class="user-info">
                <div>
                    <strong>Admin:</strong> <span id="adminName">-</span>
                </div>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>

            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3 id="totalUsers">0</h3>
                    <p>Total Users</p>
                </div>
                <div class="stat-card green">
                    <h3 id="totalPets">0</h3>
                    <p>Total Pets Registered</p>
                </div>
                <div class="stat-card orange">
                    <h3 id="totalQRCodes">0</h3>
                    <p>QR Codes Generated</p>
                </div>
                <div class="stat-card blue">
                    <h3 id="activeQRCodes">0</h3>
                    <p>Active QR Codes</p>
                </div>
                <div class="stat-card">
                    <h3 id="totalScans">0</h3>
                    <p>Total QR Scans</p>
                </div>
            </div>

            <!-- Tabs -->
            <div class="card">
                <div class="tabs">
                    <button class="tab active" onclick="showTab('users')">Users</button>
                    <button class="tab" onclick="showTab('pets')">Pets</button>
                    <button class="tab" onclick="showTab('qrcodes')">QR Codes</button>
                    <button class="tab" onclick="showTab('generate')">Generate QR</button>
                    <button class="tab" onclick="showTab('activity')">Recent Activity</button>
                </div>

                <!-- Users Tab -->
                <div id="usersTab" class="tab-content active">
                    <h2>Registered Users</h2>
                    <div class="search-box">
                        <input type="text" id="userSearch" placeholder="Search users by name, email, or phone..." onkeyup="filterUsers()">
                    </div>
                    <table class="data-table" id="usersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>QR Codes</th>
                                <th>Pets</th>
                                <th>Registered</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="usersTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pets Tab -->
                <div id="petsTab" class="tab-content">
                    <h2>All Registered Pets</h2>
                    <div class="search-box">
                        <input type="text" id="petSearch" placeholder="Search pets by name, owner, or QR code..." onkeyup="filterPets()">
                    </div>
                    <table class="data-table" id="petsTable">
                        <thead>
                            <tr>
                                <th>Pet Name</th>
                                <th>Type</th>
                                <th>Owner</th>
                                <th>QR Code</th>
                                <th>Scans</th>
                                <th>Status</th>
                                <th>Registered</th>
                            </tr>
                        </thead>
                        <tbody id="petsTableBody">
                            <tr><td colspan="7" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- QR Codes Tab -->
                <div id="qrcodesTab" class="tab-content">
                    <h2>QR Code Inventory</h2>
                    <div class="search-box">
                        <input type="text" id="qrSearch" placeholder="Search QR codes..." onkeyup="filterQRCodes()">
                    </div>
                    <table class="data-table" id="qrCodesTable">
                        <thead>
                            <tr>
                                <th>QR Code ID</th>
                                <th>Status</th>
                                <th>Batch</th>
                                <th>Assigned To</th>
                                <th>Created</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="qrCodesTableBody">
                            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>

                <!-- Generate QR Tab -->
                <div id="generateTab" class="tab-content">
                    <h2>ðŸŽ¯ Generate QR Codes</h2>
                    <form id="generateQRForm" style="max-width: 600px;">
                        <div class="form-group">
                            <label>Quantity (1-1000)</label>
                            <input type="number" id="qrQuantity" min="1" max="1000" value="10" required>
                        </div>
                        <div class="form-group">
                            <label>Batch Number (optional)</label>
                            <input type="text" id="qrBatchNumber" placeholder="e.g., BATCH-001">
                        </div>
                        <button type="submit" class="btn">Generate QR Codes</button>
                    </form>
                    <div id="generateResult" class="result"></div>
                    
                    <!-- Generated QR Codes Display -->
                    <div id="generatedQRDisplay" style="display: none; margin-top: 30px;">
                        <h3>âœ… Generated QR Codes</h3>
                        <button onclick="printQRCodes()" class="btn btn-success">Print All QR Codes</button>
                        <div id="qrGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;"></div>
                    </div>
                </div>

                <!-- Activity Tab -->
                <div id="activityTab" class="tab-content">
                    <h2>Recent Activity</h2>
                    <div id="activityList">
                        <p style="text-align: center; color: #666;">Loading recent activity...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://web-production-d424.up.railway.app';
        let adminToken = localStorage.getItem('adminToken');
        let allUsers = [];
        let allPets = [];
        let allQRCodes = [];

        // Check if already logged in
        function init() {
            if (adminToken) {
                loadDashboard();
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const resultDiv = document.getElementById('loginResult');

            try {
                const response = await fetch(`${API_BASE}/api/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: document.getElementById('adminEmail').value,
                        password: document.getElementById('adminPassword').value
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    adminToken = data.token;
                    localStorage.setItem('adminToken', adminToken);
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = 'âœ… Login successful! Loading dashboard...';
                    resultDiv.style.display = 'block';
                    
                    setTimeout(() => {
                        loadDashboard();
                    }, 1000);
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ ' + (data.error || 'Login failed');
                    resultDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Login error:', error);
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ Network error: ' + error.message;
                resultDiv.style.display = 'block';
            }
        });

        // Load Dashboard
        async function loadDashboard() {
            try {
                // Load all data in sequence to ensure pets are loaded
                await loadUsers();
                await loadPets();
                await loadQRCodes();
                await loadStats();

                // Show dashboard
                document.getElementById('loginCard').classList.add('hidden');
                document.getElementById('dashboardContent').classList.remove('hidden');
                document.getElementById('adminName').textContent = 'ShakyTails Admin';
            } catch (error) {
                console.error('Error loading dashboard:', error);
                
                // Check if it's an auth error
                if (error.message && error.message.includes('401')) {
                    alert('Session expired. Please login again.');
                    logout();
                } else {
                    alert('Failed to load dashboard: ' + error.message);
                }
            }
        }

        // Load Statistics
        async function loadStats() {
            try {
                const [usersRes, petsRes, qrRes] = await Promise.all([
                    fetch(`${API_BASE}/api/admin/users`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch(`${API_BASE}/api/admin/all-pets`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    }),
                    fetch(`${API_BASE}/api/qr-inventory/stats`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    })
                ]);

                const usersData = await usersRes.json();
                const petsData = await petsRes.json();
                const qrData = await qrRes.json();

                if (usersData.success) {
                    document.getElementById('totalUsers').textContent = usersData.users.length;
                }

                if (petsData.success) {
                    document.getElementById('totalPets').textContent = petsData.pets.length;
                    
                    // Calculate total scans
                    let totalScans = 0;
                    petsData.pets.forEach(pet => {
                        totalScans += pet.scanHistory ? pet.scanHistory.length : 0;
                    });
                    document.getElementById('totalScans').textContent = totalScans;
                }

                if (qrData.success) {
                    document.getElementById('totalQRCodes').textContent = qrData.stats.total || 0;
                    document.getElementById('activeQRCodes').textContent = qrData.stats.active || 0;
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load Users
        async function loadUsers() {
            try {
                // Get all users
                const usersResponse = await fetch(`${API_BASE}/api/admin/users`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                
                if (!usersResponse.ok) {
                    throw new Error(`HTTP error ${usersResponse.status}`);
                }
                
                const usersData = await usersResponse.json();

                if (usersData.success) {
                    // Get all pets to map QR codes to users
                    const petsResponse = await fetch(`${API_BASE}/api/admin/all-pets`, {
                        headers: { 'Authorization': `Bearer ${adminToken}` }
                    });
                    const petsData = await petsResponse.json();

                    // Map pets to users
                    const userPetsMap = {};
                    if (petsData.success) {
                        petsData.pets.forEach(pet => {
                            // Handle both populated and non-populated owner
                            let ownerId;
                            if (typeof pet.owner === 'object' && pet.owner !== null) {
                                ownerId = pet.owner._id || pet.owner.id;
                            } else {
                                ownerId = pet.owner;
                            }

                            if (ownerId) {
                                const ownerIdStr = ownerId.toString();
                                if (!userPetsMap[ownerIdStr]) {
                                    userPetsMap[ownerIdStr] = {
                                        count: 0,
                                        qrCodes: []
                                    };
                                }
                                userPetsMap[ownerIdStr].count++;
                                // Use qrCodeId field
                                if (pet.qrCodeId) {
                                    userPetsMap[ownerIdStr].qrCodes.push(pet.qrCodeId);
                                } else if (pet.qrCode) {
                                    userPetsMap[ownerIdStr].qrCodes.push(pet.qrCode);
                                }
                            }
                        });
                    }

                    // Add pet count and QR codes to users
                    allUsers = usersData.users.map(user => {
                        const userIdStr = user._id.toString();
                        return {
                            ...user,
                            petCount: userPetsMap[userIdStr]?.count || 0,
                            qrCodes: userPetsMap[userIdStr]?.qrCodes || []
                        };
                    });

                    console.log('Users with QR codes:', allUsers);
                    displayUsers(allUsers);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                throw error;
            }
        }

        // Display Users
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No users found</td></tr>';
                return;
            }

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.name}</td>
                    <td>${user.email}</td>
                    <td>${user.phone || '-'}</td>
                    <td>${user.qrCodes ? user.qrCodes.map(qr => `<code style="display: block; margin: 2px 0;">${qr}</code>`).join('') : '-'}</td>
                    <td><strong>${user.petCount || 0}</strong></td>
                    <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td><span class="badge ${user.isActive ? 'success' : 'warning'}">${user.isActive ? 'Active' : 'Inactive'}</span></td>
                </tr>
            `).join('');
        }

        // Load Pets
        async function loadPets() {
            try {
                const response = await fetch(`${API_BASE}/api/admin/all-pets`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    allPets = data.pets;
                    displayPets(allPets);
                } else {
                    console.error('Failed to load pets:', data.error);
                    document.getElementById('petsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Error loading pets</td></tr>';
                }
            } catch (error) {
                console.error('Error loading pets:', error);
                document.getElementById('petsTableBody').innerHTML = '<tr><td colspan="7" style="text-align: center; color: red;">Failed to load pets: ' + error.message + '</td></tr>';
            }
        }

        // Display Pets
        function displayPets(pets) {
            const tbody = document.getElementById('petsTableBody');
            
            if (!pets || pets.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center;">No pets found</td></tr>';
                return;
            }

            tbody.innerHTML = pets.map(pet => {
                const ownerName = pet.owner?.name || (typeof pet.owner === 'string' ? 'Unknown' : '-');
                const ownerEmail = pet.owner?.email || '-';
                return `
                    <tr>
                        <td><strong>${pet.petName || '-'}</strong></td>
                        <td>${pet.type ? pet.type.charAt(0).toUpperCase() + pet.type.slice(1) : '-'}</td>
                        <td>${ownerName}<br><small style="color: #666;">${ownerEmail}</small></td>
                        <td><code>${pet.qrCodeId || pet.qrCode || '-'}</code></td>
                        <td><strong>${pet.scanHistory ? pet.scanHistory.length : 0}</strong></td>
                        <td><span class="badge ${pet.isLost ? 'warning' : 'success'}">${pet.isLost ? 'Lost' : 'Safe'}</span></td>
                        <td>${new Date(pet.createdAt).toLocaleDateString()}</td>
                    </tr>
                `;
            }).join('');
        }

        // Load QR Codes
        async function loadQRCodes() {
            try {
                const response = await fetch(`${API_BASE}/api/qr-inventory/available?limit=1000`, {
                    headers: { 'Authorization': `Bearer ${adminToken}` }
                });
                const data = await response.json();

                if (data.success) {
                    allQRCodes = data.qrCodes;
                    displayQRCodes(allQRCodes);
                }
            } catch (error) {
                console.error('Error loading QR codes:', error);
            }
        }

        // Display QR Codes
        function displayQRCodes(qrCodes) {
            const tbody = document.getElementById('qrCodesTableBody');
            
            if (qrCodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No QR codes found</td></tr>';
                return;
            }

            tbody.innerHTML = qrCodes.map(qr => {
                const imagePath = qr.qrCodeImage || `/qrcodes/${qr.qrCodeId}.png`;
                const downloadUrl = `${API_BASE}${imagePath}`;
                return `
                <tr>
                    <td><code>${qr.qrCodeId}</code></td>
                    <td><span class="badge ${qr.status === 'available' ? 'success' : 'info'}">${qr.status}</span></td>
                    <td>${qr.batchNumber || '-'}</td>
                    <td>${qr.isAssigned ? (qr.pet?.petName || 'Assigned') : '-'}</td>
                    <td>${new Date(qr.createdAt).toLocaleDateString()}</td>
                    <td><button class="btn" onclick="downloadSingleQR('${downloadUrl}', '${qr.qrCodeId}')" style="padding: 5px 10px; font-size: 0.85rem;">Download</button></td>
                </tr>
                `;
            }).join('');
        }

        // Filter Functions
        function filterUsers() {
            const search = document.getElementById('userSearch').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.name.toLowerCase().includes(search) ||
                user.email.toLowerCase().includes(search) ||
                (user.phone && user.phone.includes(search))
            );
            displayUsers(filtered);
        }

        function filterPets() {
            const search = document.getElementById('petSearch').value.toLowerCase();
            const filtered = allPets.filter(pet => 
                pet.petName.toLowerCase().includes(search) ||
                (pet.owner?.name && pet.owner.name.toLowerCase().includes(search)) ||
                (pet.qrCode && pet.qrCode.toLowerCase().includes(search))
            );
            displayPets(filtered);
        }

        function filterQRCodes() {
            const search = document.getElementById('qrSearch').value.toLowerCase();
            const filtered = allQRCodes.filter(qr => 
                qr.qrCodeId.toLowerCase().includes(search) ||
                (qr.batchNumber && qr.batchNumber.toLowerCase().includes(search))
            );
            displayQRCodes(filtered);
        }

        // Tab Navigation
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected tab
            document.getElementById(tabName + 'Tab').classList.add('active');
            event.target.classList.add('active');
        }

        // Logout
        function logout() {
            localStorage.removeItem('adminToken');
            adminToken = null;
            document.getElementById('loginCard').classList.remove('hidden');
            document.getElementById('dashboardContent').classList.add('hidden');
            document.getElementById('adminEmail').value = 'theshakytails@gmail.com';
            document.getElementById('adminPassword').value = '';
        }

        // Generate QR Codes
        function setupGenerateQRForm() {
            const form = document.getElementById('generateQRForm');
            if (!form) return;
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const resultDiv = document.getElementById('generateResult');
                const quantity = document.getElementById('qrQuantity').value;
                const batchNumber = document.getElementById('qrBatchNumber').value;

                try {
                    resultDiv.innerHTML = 'â³ Generating QR codes...';
                    resultDiv.className = 'result';
                    resultDiv.style.display = 'block';

                const response = await fetch(`${API_BASE}/api/qr-inventory/generate-bulk`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${adminToken}`
                    },
                    body: JSON.stringify({ quantity: parseInt(quantity), batchNumber })
                });

                const data = await response.json();

                if (data.success) {
                    resultDiv.className = 'result success';
                    resultDiv.innerHTML = `âœ… Successfully generated ${data.count} QR codes! Batch: ${data.batchNumber}`;
                    
                    // Display generated QR codes
                    const qrGrid = document.getElementById('qrGrid');
                    qrGrid.innerHTML = '';
                    
                    data.qrCodes.forEach(qr => {
                        // Always use API_BASE for images
                        const imagePath = qr.qrCodeImage || `/qrcodes/${qr.qrCodeId}.png`;
                        const downloadUrl = `${API_BASE}${imagePath}`;
                        const qrItem = document.createElement('div');
                        qrItem.style.cssText = 'background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center;';
                        qrItem.innerHTML = `
                            <img src="${downloadUrl}" alt="${qr.qrCodeId}" style="width: 150px; height: 150px; margin-bottom: 10px;" crossorigin="anonymous">
                            <p style="font-size: 0.9rem; margin-bottom: 10px; word-break: break-all;"><strong>${qr.qrCodeId}</strong></p>
                            <button class="btn" onclick="downloadSingleQR('${downloadUrl}', '${qr.qrCodeId}')" style="font-size: 0.85rem; padding: 8px 16px;">Download</button>
                        `;
                        qrGrid.appendChild(qrItem);
                    });
                    
                    document.getElementById('generatedQRDisplay').style.display = 'block';
                    
                    // Reload QR codes list
                    loadQRCodes();
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.innerHTML = 'âŒ ' + (data.error || 'Failed to generate QR codes');
                }
            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.innerHTML = 'âŒ Network error: ' + error.message;
            }
            });
        }

        // Download single QR code
        function downloadSingleQR(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${filename}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                })
                .catch(error => {
                    console.error('Download error:', error);
                    alert('Download failed. Please right-click the image and save manually.');
                });
        }

        // Print QR codes
        function printQRCodes() {
            const printWindow = window.open('', '_blank');
            const qrGrid = document.getElementById('qrGrid');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Print QR Codes</title>
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .qr-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; padding: 20px; }
                        .qr-item { text-align: center; page-break-inside: avoid; }
                        .qr-item img { width: 200px; height: 200px; }
                        @media print { .no-print { display: none; } }
                    </style>
                </head>
                <body>
                    <h1 style="text-align: center;">ShakyTails QR Codes</h1>
                    <div class="qr-grid">${qrGrid.innerHTML}</div>
                    <script>window.print();<\/script>
                </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Initialize
        init();
        setupGenerateQRForm();
    </script>
</body>
</html>
